name: ci-cd-deploy-to-eks

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout the code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configure AWS credentials via OIDC
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3Ô∏è‚É£ Login to Amazon ECR
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      # 4Ô∏è‚É£ Build & Push Backend Image
      - name: Build & Push Backend Image
        run: |
          docker build -t backend ./server
          docker tag backend:latest ${{ secrets.ECR_BACKEND }}:${{ github.sha }}
          docker push ${{ secrets.ECR_BACKEND }}:${{ github.sha }}

      # 5Ô∏è‚É£ Build & Push Frontend Image
      - name: Build & Push Frontend Image
        run: |
          docker build -t frontend ./client
          docker tag frontend:latest ${{ secrets.ECR_FRONTEND }}:${{ github.sha }}
          docker push ${{ secrets.ECR_FRONTEND }}:${{ github.sha }}

      # 6Ô∏è‚É£ Update kubeconfig
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name ${{ secrets.EKS_CLUSTER_NAME }}

      # 8Ô∏è‚É£ Deploy Database (MongoDB)
      - name: Deploy Database
        run: |
          kubectl apply -f k8s/database/mongodb.yaml -n three-tier
          kubectl rollout status statefulset/mongo -n three-tier

      # 9Ô∏è‚É£ Deploy Backend
      - name: Deploy Backend
        run: |
          kubectl apply -f k8s/backend/backend.yaml -n three-tier
          kubectl rollout status deployment/backend -n three-tier

      # üîü Deploy Frontend
      - name: Deploy Frontend
        run: |
          kubectl apply -f k8s/frontend/frontend.yaml -n three-tier
          kubectl rollout status deployment/frontend -n three-tier

      # 1Ô∏è‚É£1Ô∏è‚É£ Deploy Ingress
      - name: Deploy Ingress
        run: kubectl apply -f k8s/ingress/ingress.yaml -n three-tier
